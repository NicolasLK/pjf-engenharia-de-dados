<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="Eloi Junior, Henrique Angar, Joel Francisco, Juliano Cardoso, Lorenzo, Nicolas Loffi Kaminski, Rafael Castro e Yuri Boppre">
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>About - pjf_engenharia_de_dados</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/fontawesome.min.css" rel="stylesheet">
        <link href="../css/brands.min.css" rel="stylesheet">
        <link href="../css/solid.min.css" rel="stylesheet">
        <link href="../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <link href="../style.css" rel="stylesheet">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="..">pjf_engenharia_de_dados</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item">
                                <a href=".." class="nav-link">Home</a>
                            </li>
                            <li class="nav-item">
                                <a href="./" class="nav-link active" aria-current="page">About</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href=".." class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" class="nav-link disabled">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="https://github.com/NicolasLK/pjf-engenharia-de-dados/edit/master/docs/about.md" class="nav-link">Edit on pjf_engenharia_de_dados
                                    </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#sobre-o-projeto-de-pipeline" class="nav-link">Sobre o Projeto de Pipeline</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#construcao-do-projeto" class="nav-link">Construção do Projeto</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="sobre-o-projeto-de-pipeline">Sobre o Projeto de Pipeline</h1>
<h2 id="construcao-do-projeto">Construção do Projeto</h2>
<h3 id="1-coleta-de-dados">1. Coleta de Dados</h3>
<ul>
<li>Como mencionado na pagina <em>Home</em> utilizamos o seguinte <em><a href="https://www.kaggle.com/datasets/olistbr/brazilian-ecommerce">Dataset</a></em> para manipulação de dados, segue o diagrama relacional:</li>
</ul>
<p><img alt="Diagrama_Relacional" src="../assets/Diagrama_ER.jpg" /></p>
<ul>
<li>Utilizamos o airflow para iniciar a coleta dos dados de um banco relacional, com objetivo de popular a camada de <em>Landing</em>.</li>
</ul>
<pre><code class="language-bash">Codigo aqui
</code></pre>
<h3 id="2-processamento-de-dados">2. Processamento de Dados</h3>
<ul>
<li>O processamento segue o seguinte fluxo:
  <br></li>
</ul>
<p><img alt="Desenho_da_Arquitetura" src="../assets/Modelo_Arquitetura.png" /></p>
<ul>
<li>Começando pela camada Landing:
  <br></li>
</ul>
<h4 id="camada-landing">Camada <em>Landing</em></h4>
<p>Com o código abaixo iniciamos uma sessão Spark utilizando Delta Lake.</p>
<pre><code class="language-bash"># Iniciando uma SparkSession com Delta Lake
spark = SparkSession.builder \
    .appName(&quot;DeltaLakeSparkS3&quot;) \
    .config(&quot;spark.sql.extensions&quot;, &quot;io.delta.sql.DeltaSparkSessionExtension&quot;) \
    .config(&quot;spark.sql.catalog.spark_catalog&quot;, &quot;org.apache.spark.sql.delta.catalog.DeltaCatalog&quot;) \
    .getOrCreate()
</code></pre>
<ul>
<li>Como comentado na <em>Home</em> estamos utilizando <strong>Amazon S3</strong>.</li>
</ul>
<pre><code class="language-bash"># Função para ler dados do S3
def read_from_s3(bucket, path):
    try:
        df = spark.read.format(&quot;csv&quot;).option(&quot;header&quot;, &quot;true&quot;).load(f&quot;s3a://{bucket}/{path}&quot;)
        return df
    except Exception as e:
        print(f&quot;Erro ao ler dados do S3: {e}&quot;)
</code></pre>
<ul>
<li>Depois de realizado a leitura, salvamos os dados em formato <em>PARQUET</em> e direcionamos os dados para a camada <strong>Bronze</strong>.</li>
</ul>
<pre><code class="language-bash"># Função principal
def main():
    try:
        # Definindo os caminhos dos arquivos CSV na landing
        paths = ['geo.csv', 'dadosprodutos.csv', 'pedidos.csv', 'clientes.csv', 'vendedores.csv', 'pagamentos.csv', 'dadospedidos.csv']
        dfs = {}
        for path in paths:
            df_name = path.split('.')[0]
            dfs[df_name] = read_from_s3(landing_bucket, f&quot;/{path}&quot;)

        # Salvando os DataFrames no formato Parquet usando Delta Lake no bucket da camada bronze
        for df_name, df in dfs.items():
            df.write.format(&quot;delta&quot;).mode('overwrite').save(f&quot;s3a://{bronze_bucket}/{df_name}&quot;)

        print(&quot;Dados salvos na camada bronze com sucesso.&quot;)

    except Exception as e:
        print(f&quot;Erro no processo principal: {e}&quot;)

if __name__ == &quot;__main__&quot;:
    main()
</code></pre>
<hr>

<h4 id="camada-bronze">Camada <em>Bronze</em></h4>
<p>Agora os dados se encontram na camada <em>Bronze</em>.
<br></p>
<ul>
<li>Como iniciamos outro processo é necessario iniciar outra sessão Spark.</li>
</ul>
<pre><code class="language-bash"># Iniciando uma SparkSession com Delta Lake
spark = SparkSession.builder \
    .appName(&quot;BronzeLayer&quot;) \
    .config(&quot;spark.sql.extensions&quot;, &quot;io.delta.sql.DeltaSparkSessionExtension&quot;) \
    .config(&quot;spark.sql.catalog.spark_catalog&quot;, &quot;org.apache.spark.sql.delta.catalog.DeltaCatalog&quot;) \
    .getOrCreate()
</code></pre>
<ul>
<li>Agora carregamos os dados para a camada <em>Bronze</em>.</li>
</ul>
<pre><code class="language-bash">  # Carregar arquivos Delta da camada bronze
  localizacoes = spark.read.format(&quot;delta&quot;).load(f'{bronze_bucket}/localizacoes')
  produtos = spark.read.format(&quot;delta&quot;).load(f'{bronze_bucket}/dadosprodutos')
  pedidos = spark.read.format(&quot;delta&quot;).load(f'{bronze_bucket}/pedidos')
  clientes = spark.read.format(&quot;delta&quot;).load(f'{bronze_bucket}/clientes')
  vendedores = spark.read.format(&quot;delta&quot;).load(f'{bronze_bucket}/vendedores')
  pagamentos = spark.read.format(&quot;delta&quot;).load(f'{bronze_bucket}/pagamentos')
  dadospedidos = spark.read.format(&quot;delta&quot;).load(f'{bronze_bucket}/dadospedidos')
</code></pre>
<ul>
<li>Renomeamos as colunas.</li>
</ul>
<pre><code class="language-bash">  # Renomear colunas
  clientes = clientes.withColumnRenamed('idgeralcliente', 'idcliente')
  produtos = produtos.withColumnRenamed('id_produto', 'idproduto')
</code></pre>
<ul>
<li>Criação da tabela dimensional <strong>DIM_DATA</strong> e utilizando ela para criar os <strong>DataFrames</strong>.</li>
</ul>
<pre><code class="language-bash">  # CRIA DIM_DATA

  # Gerar uma lista de datas de 2015 até hoje + 1 dia
  end_date = datetime.now() + timedelta(days=1)
  dates = [end_date - timedelta(days=x) for x in range((end_date - datetime(2015, 1, 1)).days + 1)]

  # Criar um DataFrame com as datas
  schema = StructType([
      StructField('dt_data', StringType(), True)
  ])
  df = spark.createDataFrame([(d.strftime('%Y-%m-%d'),) for d in dates], schema=schema)

  df = df.withColumn('dt_diasemana', dayofweek(col('dt_data')))
  df = df.withColumn('dt_diasemana_ord', dayofweek(col('dt_data')))
  df = df.withColumn('dt_mesano', col('dt_data').substr(0, 7))
  df = df.withColumn('dt_mesano_ord', (year(col('dt_data')) - 2015) * 12 + month(col('dt_data')))
  df = df.withColumn('dt_trimestre', quarter(col('dt_data')))
  df = df.withColumn('dt_trimestre_ord', (year(col('dt_data')) - 2015) * 4 + quarter(col('dt_data')))
  df = df.withColumn('dt_ano', year(col('dt_data')))
  df = df.withColumn('sk_data', year(col('dt_data')))
</code></pre>
<ul>
<li>Necessario reorganizar as colunas para o <strong>formato especificado</strong>.</li>
</ul>
<pre><code class="language-bash">  # Reorganizar as colunas conforme o formato especificado
  datas = df.select('sk_data', 'dt_data', 'dt_diasemana', 'dt_diasemana_ord', 'dt_mesano', 'dt_mesano_ord', 'dt_trimestre', 'dt_trimestre_ord', 'dt_ano')
</code></pre>
<ul>
<li>Criação da tabela dimensional <strong>DIM_PEDIDOS</strong>. Logo em seguida salvamos na camada <em>Silver</em>.</li>
</ul>
<pre><code class="language-bash">### CRIA PEDIDOS ###

temp = pedidos.join(dadospedidos, on='idpedido', how='left') \
    .join(pagamentos, on='idpedido', how='left') \
    .join(vendedores, on='idvendedor', how='left') \
    .join(clientes, on='idcliente', how='left') \
    .join(produtos, on='idproduto', how='left')

temp.show()
temp.filter(temp['cepcliente'].isNotNull()).show()

### SALVAR TABELAS NA CAMADA SILVER ###

temp.write.format(&quot;delta&quot;).mode('overwrite').save(f'{silver_bucket}/pedidos')
localizacoes.write.format(&quot;delta&quot;).mode('overwrite').save(f'{silver_bucket}/localizacoes')
datas.write.format(&quot;delta&quot;).mode('overwrite').save(f'{silver_bucket}/dim_data')
</code></pre>
<hr>

<h4 id="camada-silver">Camada <em>Silver</em></h4>
<p>Entrando na camada <em>Silver</em>.
<br></p>
<ul>
<li>Nova camada, nova sessão Spark.</li>
</ul>
<pre><code class="language-bash"># Iniciando uma SparkSession com Delta Lake
spark = SparkSession.builder \
    .appName(&quot;SilverLayer&quot;) \
    .config(&quot;spark.sql.extensions&quot;, &quot;io.delta.sql.DeltaSparkSessionExtension&quot;) \
    .config(&quot;spark.sql.catalog.spark_catalog&quot;, &quot;org.apache.spark.sql.delta.catalog.DeltaCatalog&quot;) \
    .getOrCreate()
</code></pre>
<ul>
<li>Carregando os dados na camada <em>Silver</em>.</li>
</ul>
<pre><code class="language-bash">  # Carregar arquivos Delta da camada silver
  datas = spark.read.format(&quot;delta&quot;).load(f'{silver_bucket}/dim_data')
  pedidos = spark.read.format(&quot;delta&quot;).load(f'{silver_bucket}/pedidos')
  localizacoes = spark.read.format(&quot;delta&quot;).load(f'{silver_bucket}/localizacoes')
</code></pre>
<ul>
<li>Renomeando colunas para utilizar IDs sequenciais.</li>
</ul>
<pre><code class="language-bash"># Renomear colunas e adicionar IDs sequenciais
pedidos = pedidos.withColumn('sk_pedido', monotonically_increasing_id())
localizacoes = localizacoes.withColumn('sk_loc', col('cep').cast(IntegerType()))

# Calcular volume e massa dos pedidos
pedidos = pedidos.withColumn('volume', (col('comprimento_cm') * col('altura_cm') * col('largura_cm')) / (100*100*100))
pedidos = pedidos.withColumn('massa', col('peso_g') / 1000)
</code></pre>
<ul>
<li>Selecionando colunas para realizar transações.</li>
</ul>
<pre><code class="language-bash"># Selecionar colunas para transações
transacoes = pedidos.select(
    col('sk_pedido').alias('sk_pedido'),
    col('idcliente').alias('idcliente'),
    col('idvendedor').alias('idvendedor'),
    col('pagamento').alias('pagamento'),
    co
</code></pre>
<ul>
<li>Criando tebelas ENTREGAS e PEDIDOS.</li>
</ul>
<pre><code class="language-bash">### CRIANDO ENTREGAS ###
entregas = pedidos.select(
    col('sk_pedido').alias('sk_pedido'),
    col('categoria').alias('categoria'),
    col('statuspedido').alias('statuspedido'),
    col('cepcliente').alias('cepcliente'),
    col('cepvendedor').alias('cepvendedor')
)
entregas = entregas.join(localizacoes.withColumnRenamed('sk_loc', 'destino'), entregas.cepcliente == localizacoes.cep, 'left')

entregas = entregas.select(
    col('sk_pedido').alias('sk_pedido'),
    col('categoria').alias('categoria'),
    col('statuspedido').alias('statuspedido'),
    col('destino').alias('destino'),
    col('cepvendedor').alias('cepvendedor')
)

entregas = entregas.join(localizacoes.withColumnRenamed('sk_loc', 'origem'), entregas.cepvendedor == localizacoes.cep, 'left')

entregas = entregas.select(
    col('sk_pedido').alias('sk_pedido'),
    col('categoria').alias('categoria'),
    col('statuspedido').alias('statuspedido'),
    col('origem').alias('origem'),
    col('destino').alias('destino')
)

### CRIANDO PEDIDOS ###

pedidos = pedidos.withColumn('datacompra', to_date(col('datacompra')))
pedidos = pedidos.withColumn('datacliente', to_date(col('datacliente')))
pedidos = pedidos.withColumn('prazo', to_date(col('prazo')))

pedidos = pedidos.withColumn('ped_diasentrega', (col('datacliente').cast('long') - col('datacompra').cast('long')) / (24*60*60))
pedidos = pedidos.withColumn('ped_diasprazo', (col('prazo').cast('long') - col('datacompra').cast('long')) / (24*60*60))

fato = pedidos.select(
    col('sk_pedido').alias('sk_pedido'),
    col('datacompra').alias('datacompra'),
    col('iditem').alias('iditem'),
    col('preco').alias('preco'),
    col('frete').alias('frete'),
    col('volume').alias('volume'),
    col('massa').alias('massa'),
    col('ped_diasentrega').alias('ped_diasentrega'),
    col('ped_diasprazo').alias('ped_diasprazo')
)

datas = datas.withColumn('dt_data', to_date(col('dt_data')))
fato = fato.join(datas, fato.datacompra == datas.dt_data, 'left').select(
    col('sk_pedido').alias('sk_pedido'),
    col('sk_data').alias('sk_data'),
    col('iditem').alias('iditem'),
    col('preco').alias('preco'),
    col('frete').alias('frete'),
    col('volume').alias('volume'),
    col('massa').alias('massa'),
    col('ped_diasentrega').alias('ped_diasentrega'),
    col('ped_diasprazo').alias('ped_diasprazo')
)
</code></pre>
<ul>
<li>Utilizando a função Haversine(Calculo da distancia entre duas coordenadas) e aplicando no DataFrame.</li>
</ul>
<pre><code class="language-bash"># Função Haversine
def haversine(lat1, lon1, lat2, lon2):
    if lat1 is None or lon1 is None or lat2 is None or lon2 is None:
        return None

    R = 6371.0  # Raio da Terra em quilômetros

    lat1_rad = math.radians(lat1)
    lon1_rad = math.radians(lon1)
    lat2_rad = math.radians(lat2)
    lon2_rad = math.radians(lon2)

    dlat = lat2_rad - lat1_rad
    dlon = lon2_rad - lon1_rad

    a = math.sin(dlat / 2)**2 + math.cos(lat1_rad) * math.cos(lat2_rad) * math.sin(dlon / 2)**2
    c = 2 * math.atan2(math.sqrt(a), math.sqrt(1 - a))

    distance = R * c
    return distance

# Registrar a função como UDF
haversine_udf = udf(haversine, DoubleType())

# Aplicar a UDF ao DataFrame
pedidos = pedidos.withColumn('distancia_km', haversine_udf(pedidos['lat1'], pedidos['long1'], pedidos['lat2'], pedidos['long2']))

pedidos = pedidos.drop('lat1', 'long1', 'lat2', 'long2')
</code></pre>
<ul>
<li>Salvando dados na camada <em>Gold</em>.</li>
</ul>
<pre><code class="language-bash">### SALVAR TABELAS NA CAMADA GOLD ###

datas.write.format(&quot;delta&quot;).mode('overwrite').save(f'{gold_bucket}/dim_data')
fato.write.format(&quot;delta&quot;).mode('overwrite').save(f'{gold_bucket}/fato_pedidos')
entregas.write.format(&quot;delta&quot;).mode('overwrite').save(f'{gold_bucket}/dim_entregas')
transacoes.write.format(&quot;delta&quot;).mode('overwrite').save(f'{gold_bucket}/dim_transacao')
localizacoes.write.format(&quot;delta&quot;).mode('overwrite').save(f'{gold_bucket}/dim_localizacoes')
</code></pre>
<!-- ### 3. Automação

- O carregamento de dados na pipeline é realizado automaticamente por meio do método airflow.
  <br>
  **Explicação:**

  **Exeplo:**

```bash
Codigo aqui
``` --></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js"></script>
        <script src="../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
